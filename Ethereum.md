# Ethereum
## Introduction
- [什麼是以太坊](https://www.alchemy.com/docs/what-is-ethereum)
- Ethereum（以太坊） 是一個 去中心化的區塊鏈平台，支援 智慧合約（Smart Contracts） 和 去中心化應用（dApps）。它的原生加密貨幣是 Ether（ETH），通常用於支付交易費用和網路運作
    - feature
        - 去中心化：沒有單一機構控制，所有交易和應用都透過區塊鏈運行。
        - 智慧合約：允許開發者建立自動執行的程式，無需第三方介入。
        - 去中心化金融（DeFi）：支持借貸、交易、支付等金融應用，無需傳統銀行。
        - NFT（非同質化代幣）：用於數位藝術、遊戲資產等獨特數位物品的交易
    - difference
        - 比特幣（BTC） 主要用於 價值儲存 和 支付，而 Ethereum 則是 可編程的區塊鏈，支援各種應用。
        - Ethereum 於 2022 年 9 月 完成 The Merge 升級，從 PoW（工作量證明） 轉換為 PoS（權益證明），降低能源消耗 99%。
- 備註：比特幣（Bitcoin）和以太坊（Ethereum）
    - 是兩種最具影響力的加密貨幣，但它們的設計目標和技術架構有顯著不同。以下是它們的 相似點 和 不同點
    - 相同
        - 區塊鏈技術：兩者都使用區塊鏈來記錄交易，確保去中心化和安全性。
        - 加密貨幣：比特幣（BTC）和以太幣（ETH）都是數位資產，可用於支付或投資。
        - 去中心化：沒有中央機構控制，交易透過全球節點驗證。
        - 挖礦（過去）：比特幣仍使用 工作量證明（PoW），而以太坊在 2022 年之前也使用 PoW，但已轉換為 權益證明（PoS）。
    - 不同
        - | 比較項目 | 比特幣（BTC） | 以太坊（ETH） | 
          |-----------|-------------|---------------|
          | 創立時間 | 2009 年 | 2015 年 | 
          | 創始人 | 中本聰（Satoshi Nakamoto） | Vitalik Buterin | 
          | 主要用途 | 數位貨幣、價值儲存 | 智慧合約、去中心化應用（dApps） | 
          | 供應量 | 2100 萬枚（固定） | 無上限（但有發行機制） | 
          | 共識機制 | PoW（工作量證明） | PoS（權益證明） | 
          | 區塊時間 | 約 10 分鐘 | 約 12-14 秒 | 
          | 交易速度 | 慢（每秒約 7 筆交易） | 快（每秒約 30 筆交易） | 
          | 智慧合約 | 不支援 | 支援（可編程） | 
          | 主要貨幣 | BTC    |    ETH      |
          | 狀態模型 | UTXO   | 基礎帳戶   |
 - 備註：Account-based and UTXO models
    - Account-based model: Like a debit card—you subtract
    directly from your balance, no change needed
    - UTXO model: Like carrying a bunch of cash bills. To spend 7 units, you might hand over a 10-unit note and get 3 back as change.
- Ethereum virtual machine(EVM) 是以太坊區塊鏈的核心技術，它是一個 去中心化的虛擬環境，負責執行 智慧合約（Smart Contracts） 和 去中心化應用（DApps）
    - function
        - 智慧合約執行：EVM 負責處理智慧合約的邏輯，使其能夠在區塊鏈上自動執行.
        - 去中心化運行：EVM 在所有以太坊節點上運行，確保沒有單一機構控制交易.
        - 計算資源管理（Gas 機制）：EVM 使用 Gas 來衡量運算成本，防止濫用網路資源.
        - 狀態管理：EVM 維護所有帳戶和合約的狀態，確保交易的完整性.
    - way of working
        - 開發者使用 Solidity 編寫智慧合約，並透過 ethereum compiler 將其編譯成 EVM Bytecode
        - EVM 透過 Gas 計算執行成本，確保交易不會消耗過多資源.
        - 每個節點執行相同的 EVM 指令，確保交易結果一致.
- Turing completeness 是計算理論中的一個概念，指的是一個系統（例如程式語言或計算機）能夠執行 任何可計算的問題，只要有足夠的時間和記憶體。
    - condition
        - 條件分支（Conditional Branching）：能夠根據不同條件執行不同的指令。
        - 記憶體操作（Memory Manipulation）：能夠存儲、修改和檢索資料。
        - 無限循環（Infinite Looping）：能夠執行迴圈，這對於解決複雜問題至關重要.
    - application
        - 程式語言：大多數現代程式語言（如 Python、C++、Java）都是圖靈完備的，因為它們能夠執行任何可計算的函數.
        - 區塊鏈：以太坊的 EVM（Ethereum Virtual Machine） 是圖靈完備的，這使得它能夠執行智慧合約。
        - 計算機：現代電腦基本上都是圖靈完備的，因為它們能夠模擬圖靈機的運算能力
- 備註：halting problem
    -  是計算理論中的一個經典問題，它探討是否能夠設計一個演算法來判斷 任意程式 在 特定輸入 下是否會停止運行，或者會進入無限迴圈。
    - 停機問題的核心概念
        - 問題描述：給定一個程式 P 和一個輸入 I，我們是否能設計一個演算法 H(P, I) 來判斷 P 在 I 上是否會停止？
        - 圖靈機（Turing Machine）：停機問題通常使用 圖靈機 來描述計算模型，因為它代表了所有可計算的問題。
        - 停機問題是不可解的：英國數學家 艾倫·圖靈（Alan Turing） 在 1936 年證明，不存在 一個通用演算法可以正確判斷所有程式是否會停止。
    - 停機問題的影響
        - 計算理論：它證明了某些問題是 不可計算的，即使我們擁有無限的計算資源。
        - 程式分析：在軟體開發中，無法設計一個通用工具來判斷所有程式是否會進入無限迴圈。
        - 人工智慧與數學：許多 AI 和數學問題涉及停機問題，影響決策系統的可計算性
    - 備註：在 algorithm 中，最後 P 和 NP 那裏有詳細講解
- 備註：GAS
    - Gas 在以太坊網路中基本上就是 交易手續費，但它的計算方式與傳統銀行的手續費不同。Gas 負責支付 網路運算成本，確保交易或智慧合約能夠順利執行
    - 每筆交易都需要 Gas
        - 在以太坊上，任何交易（如轉帳、執行智慧合約）都需要支付 Gas 費用。
        - Gas 費用以 ETH 計算，通常使用 Gwei（1 Gwei = 0.000000001 ETH）。
    - Gas 費用的組成
        - 基本費用（Base Fee）：由網路需求決定，當網路擁擠時，費用會上升。
        - 優先費（Priority Fee）：使用者可以支付額外費用來加快交易速度。
        - Gas 限制（Gas Limit）：每筆交易的最大 Gas 消耗量，確保交易不會無限執行。
    - Gas 與網路擁擠
        - 當以太坊網路擁擠時，Gas 費用會上升，因為礦工或驗證者會優先處理手續費較高的交易。
        - 使用者可以選擇 Layer 2 解決方案（如 Polygon、Optimism）來降低 Gas 費用
## Transaction
- 是指 在以太坊區塊鏈上執行的操作，例如轉帳 ETH、執行智慧合約或與去中心化應用（dApps）互動
- type
    - 普通交易（Regular Transaction）
        - 這是最基本的交易，從一個帳戶轉移 ETH 到另一個帳戶。
    - 合約部署交易（Contract Deployment Transaction）
        - 這類交易沒有「接收地址」，而是用來部署新的智慧合約。
    - 合約執行交易（Contract Execution Transaction）
        - 這類交易與已部署的智慧合約互動，例如執行 DeFi 操作或 NFT 交易。
- flow
    - 交易發起：使用者透過錢包（如 MetaMask）輸入接收地址、金額和 Gas 費用。
    - 交易簽名：交易必須使用私鑰簽名，以確保安全性。
    - 交易廣播：交易被發送到以太坊網路，進入「記憶池（Mempool）」等待處理。
    - 驗證與打包：驗證者（Validator）選擇交易並將其加入區塊。
    - 區塊確認：交易被記錄在區塊鏈上，並獲得多次確認以確保安全。
- component
    - 發送者（From）：交易的發起者地址。
    - 接收者（To）：交易的接收地址（可能是帳戶或智慧合約）。
    - 金額（Value）：轉移的 ETH 數量。
    - Gas 限制（Gas Limit）：交易可消耗的最大 Gas 數量。
    - Gas 費用（Gas Fee）：支付給驗證者的費用，以 ETH 計算。
    - 交易數據（Input Data）：如果交易涉及智慧合約，這部分包含執行的指令。
- 備註：NFT
    - 是一種獨特的數位資產，通常用於代表 藝術品、音樂、影片、遊戲物品 或 其他獨特的數位內容。與比特幣或以太幣不同，NFT 不可互換，每個 NFT 都有獨特的識別碼，使其具有獨特性和稀缺性。
    - feature
        - 獨特性：每個 NFT 都有獨特的識別碼，無法與其他 NFT 互換。
        - 不可分割：不像比特幣可以分割成小數點後的單位，NFT 只能作為整體交易。
        - 區塊鏈技術：NFT 透過區塊鏈（通常是以太坊）記錄所有權，確保透明度和安全性。
        - 可驗證性：所有 NFT 的交易和所有權都可以在區塊鏈上公開查詢，防止偽造
    - application
        - 數位藝術：藝術家可以透過 NFT 販售數位作品，確保版權和所有權。
        - 遊戲物品：許多區塊鏈遊戲使用 NFT 來代表角色、武器或其他虛擬物品。
        - 音樂與影片：音樂人和創作者可以透過 NFT 販售獨家內容，直接與粉絲互動。
        - 虛擬土地：在元宇宙（Metaverse）中，NFT 可用於購買虛擬土地或房產。
- type of account on Ethereum
    - 外部擁有帳戶（EOA）
        - 由私鑰控制：EOA 由使用者的 私鑰 控制，這意味著只有擁有私鑰的人才能發送交易。
        - 主要用途：
            - 轉移 ETH 或代幣。
            - 與智慧合約互動。
            - 部署新的智慧合約。
        - 特點：
            - 交易可以由帳戶持有者主動發起。
            - 交易手續費（Gas）由帳戶持有者支付
    - 合約帳戶（CA）
        - 由智慧合約控制：CA 不是由私鑰控制，而是由 區塊鏈上的程式碼 控制。
        - 主要用途：
            - 執行智慧合約邏輯，例如 DeFi、NFT、市場交易等。
            - 自動執行特定條件下的操作（例如當某條件滿足時自動轉帳）。
        - 特點：
            - 不能主動發起交易，必須由 EOA 觸發。
            - 交易執行時會消耗 Gas，並根據合約邏輯執行不同的操作
- contract creation and message call
    - 合約創建是指 部署新的智慧合約 到以太坊區塊鏈：
        - 發起者：通常由 外部擁有帳戶（EOA） 發起。
        - 交易類型：合約創建交易 沒有接收地址（To Address），因為它的目的是建立新合約。
        - 合約程式碼：交易的 data 欄位包含智慧合約的 編譯後程式碼（Bytecode）。
        - Gas 費用：合約創建需要支付 Gas，因為它涉及區塊鏈存儲和計算。
    - 訊息呼叫是指 與智慧合約互動 的交易：
        - 發起者：通常由 EOA 或其他合約 發起。
        - 交易類型：這類交易的 To 欄位是智慧合約地址。
        - 函數執行：交易的 data 欄位包含要執行的 合約函數 和 參數。
        - 狀態變更：如果合約函數修改區塊鏈上的資料，則交易會消耗 Gas。
- Message calls: send transaction vs. send message
    - 發送交易（Send Transaction）
        - 影響區塊鏈狀態：交易會改變區塊鏈上的資料，例如轉帳 ETH 或執行智慧合約。
        - 需要 Gas 費用：交易會消耗 Gas，並由礦工或驗證者處理。
        - 交易會被記錄在區塊鏈上：所有交易都會被永久存儲，並可在區塊瀏覽器上查詢
    - 發送訊息（Send Message）
        - 不影響區塊鏈狀態：訊息呼叫只是執行合約函數，但不會改變區塊鏈上的資料。
        - 不需要 Gas 費用：因為它不會被礦工處理，也不會進入區塊鏈。
        - 僅用於本地測試：開發者可以使用訊息呼叫來模擬交易結果，而不真正執行交易。
- Three routes to interact with Ethereum
    - 區塊鏈橋接（Bridges）
        - 跨鏈互動：區塊鏈橋接允許不同區塊鏈（如 Ethereum 和 BNB Chain）之間轉移資產和數據。
    - 節點與客戶端（Nodes & Clients）
        - 節點（Nodes）：節點是運行以太坊區塊鏈的電腦，負責存儲、驗證和傳播交易。
        - 客戶端（Clients）：客戶端是節點運行的軟體，例如 Geth、OpenEthereum 和 Nethermind
    - 智能合約與 dApps（Smart Contracts & dApps）
        - 智能合約：以太坊支持可編程的智能合約，允許自動執行交易和應用邏輯。
        - 去中心化應用（dApps）：透過智能合約運行的應用，例如 DeFi、NFT 市場和遊戲。
        - 與 dApps 互動方式：
            - Web3 錢包（如 MetaMask）：使用者可以透過 Web3 錢包與 dApps 互動。
            - API 介面：開發者可以使用 Web3.js 或 ethers.js 來與智能合約溝通。
- nonce of EOA
    - 在以太坊（Ethereum）中，Nonce 是 外部擁有帳戶（EOA） 的一個重要數值，它代表該帳戶已發送的交易數量。每次 EOA 發送交易時，Nonce 都會增加 1，確保交易的順序性並防止重複執行
    - Nonce 的作用
        - 確保交易順序
            - 以太坊網路會根據 Nonce 來確保交易按正確順序執行。
            - 例如，如果一個帳戶的 Nonce 為 5，那麼它的下一筆交易必須使用 6，否則交易會失敗。
        - 防止重播攻擊（Replay Attack）
            - 如果沒有 Nonce，攻擊者可以重複廣播已簽名的交易，使其被多次執行。
            - Nonce 確保每筆交易只能執行一次，避免惡意重播。
        - 交易管理
            - 使用者可以透過 Nonce 來控制交易的執行順序，例如取消未確認的交易或加速交易處理。
            - 如果交易卡住，使用者可以發送一筆 相同 Nonce 的新交易，並提高 Gas 費用來優先處理。
## Block
- Merkle Patricia Trie（MPT） 是一種 資料結構，結合了 Merkle Tree 和 Patricia Trie 的特性，主要用於 以太坊（Ethereum） 的區塊鏈存儲系統
    - advantage
        - 資料完整性驗證
            - Merkle Tree 透過哈希值確保資料未被篡改，提供高效的驗證機制。
        - 高效的鍵值存儲
            - Patricia Trie 允許快速查找、插入和刪除資料，使得區塊鏈狀態更新更有效率。
        - 去中心化帳本管理
            - 以太坊使用 MPT 來存儲 交易、收據和帳戶狀態，確保所有節點能夠一致地驗證區塊鏈狀態。
    - structure
        - Merkle Tree：透過哈希函數建立樹狀結構，確保資料完整性。
        - Patricia Trie：使用壓縮路徑的方式來存儲鍵值對，提高查找效率。
        - MPT（Merkle Patricia Trie）：結合兩者，提供高效且安全的區塊鏈資料存儲方式。
    - application
        - 交易樹（Transaction Trie）：存儲區塊內的所有交易。
        - 收據樹（Receipt Trie）：存儲交易的執行結果與事件日誌。
        - 狀態樹（State Trie）：存儲所有帳戶的餘額、智慧合約代碼和存儲資料。
    - [範例](https://commons.wikimedia.org/w/index.php?curid=2118795) 
## Proof of Stake (PoS)
- 權益證明（Proof of Stake, PoS） 是一種區塊鏈共識機制，與 PoW 不同，它不需要礦工透過計算來競爭解決數學難題，而是透過 質押（Staking） 來選擇驗證者：
    - 驗證者（Validators） 需要質押 ETH 來參與交易驗證。
    - 隨機選擇驗證者 來產生新區塊，而不是透過算力競爭。
    - 降低能源消耗，因為不需要大量計算資源。
- 為什麼以太坊從 PoW 轉換成 PoS
    - 降低能源消耗 🌱
        - PoW 需要大量計算資源，導致高能耗，而 PoS 減少了 99.95% 的能源使用。
    - 提升網路安全性 🔒
        - PoS 透過 質押機制 讓驗證者有經濟動機維護網路，避免惡意行為。
        - 惡意行為者可能會失去質押的 ETH，這使得攻擊成本更高。
    - 提高可擴展性 🚀
        - PoW 交易速度較慢，而 PoS 允許更快的交易處理，提高網路效能。
        - 以太坊 2.0 計畫透過 分片技術（Sharding） 來進一步提升交易吞吐量
- 備註：分片技術(sharding)
    - 是以太坊在 PoS（權益證明） 機制下的一種 擴展解決方案，旨在提高網路的 交易處理能力 和 可擴展
    - flow
        - 將區塊鏈拆分成多個「分片」
            - 以太坊網路被分成多個 獨立的分片（Shards），每個分片負責處理自己的交易和智能合約。
            - 這樣可以讓不同分片 同時處理交易，提高網路吞吐量。
        - 驗證者（Validators）負責分片
            - 在 PoS 機制下，驗證者會被隨機分配到不同的分片，確保網路安全性。
            - 每個分片的驗證者負責處理該分片內的交易，而不需要處理整個區塊鏈的所有交易。
        - 跨分片溝通（Cross-Shard Communication）
            - 分片之間可以透過 跨分片交易 來交換資訊，確保不同分片的數據能夠同步。
            - 這使得以太坊仍然保持 去中心化，但能夠更有效率地運行。
    - 為什麼 PoS 適合分片技術？
        - PoW（工作量證明）不適合分片，因為它依賴於礦工的算力競爭，而分片會降低單個分片的安全性。
        - PoS 透過質押機制確保安全，驗證者必須質押 ETH，並且會被隨機分配到不同分片，降低攻擊風險。
        - 提高交易速度，分片技術讓以太坊能夠處理更多交易，降低 Gas 費用。
    - effect
        - 提升交易處理能力：以太坊的交易速度將大幅提升，可能達到 數千 TPS（每秒交易數）。
        - 降低 Gas 費用：由於交易不再集中在單一區塊鏈，網路擁擠度降低，手續費也會下降。
        - 增強去中心化：更多使用者可以參與驗證，而不需要運行完整節點。
- Heaviest Chain Rule（最重鏈規則） 是區塊鏈共識機制中的一種 鏈選擇規則，用來決定哪條鏈應該被視為「主鏈」。這個規則的核心概念是選擇 累積工作量最多 的區塊鏈，而不是單純選擇最長的鏈。
    - flow
        - 計算每條鏈的「重量」
            - 每個區塊都有一個 難度值（Difficulty），代表挖掘該區塊所需的計算工作量。
            - 「重量」是指從區塊鏈起點（Genesis Block）到某個區塊的 累積難度總和。
            - 這意味著，最重的鏈不一定是擁有最多區塊的鏈，而是 累積最多工作量 的鏈。
        - 選擇最重的鏈作為主鏈
            - 當區塊鏈出現分叉時，節點會選擇 累積難度最高 的鏈作為主鏈，而不是單純選擇最長的鏈。
            - 這確保了區塊鏈的安全性，因為攻擊者需要投入 極高的計算資源 才能改變主鏈。
- Gas fee





























  




























